<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Gestore Compiti - Gruppo Visconti</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Gestisci i compiti del team Gruppo Visconti - Join the ReEvolution">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Gruppo Visconti Tasks">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .company-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            gap: 15px;
            font-family: 'Arial', sans-serif;
        }

        .logo-text {
            font-size: 2.8rem;
            font-weight: 900;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .gruppo-text {
            background: linear-gradient(135deg, #ff8c00 0%, #ffa500 50%, #ffb347 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(255, 140, 0, 0.3);
        }

        .visconti-text {
            background: linear-gradient(135deg, #228b22 0%, #32cd32 50%, #90ee90 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(34, 139, 34, 0.3);
        }

        .tagline {
            font-size: 1rem;
            color: #ecf0f1;
            font-style: italic;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-weight: 300;
            opacity: 0.9;
        }

        @supports not (-webkit-background-clip: text) {
            .gruppo-text { color: #ffa500; }
            .visconti-text { color: #32cd32; }
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            padding: 30px;
        }

        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideInRight 0.3s ease-out;
            position: relative;
            cursor: pointer;
        }

        .alert-success { 
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); 
            color: white; 
            border-left: 5px solid #27ae60; 
        }
        .alert-warning { 
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); 
            color: white; 
            border-left: 5px solid #e67e22; 
        }
        .alert-danger { 
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); 
            color: white; 
            border-left: 5px solid #c0392b; 
        }
        .alert-info { 
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); 
            color: white; 
            border-left: 5px solid #2980b9; 
        }

        .alert-title { font-weight: 600; margin-bottom: 5px; font-size: 1.1rem; }
        .alert-message { opacity: 0.9; line-height: 1.4; }
        .alert-close {
            position: absolute; top: 10px; right: 15px; background: none; border: none;
            color: white; font-size: 1.2rem; cursor: pointer; opacity: 0.7; transition: opacity 0.3s;
        }
        .alert-close:hover { opacity: 1; }

        @keyframes slideInRight { 
            from { transform: translateX(100%); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
        }
        @keyframes slideOutRight { 
            from { transform: translateX(0); opacity: 1; } 
            to { transform: translateX(100%); opacity: 0; } 
        }

        .due-badge {
            padding: 3px 8px; border-radius: 12px; font-size: 0.7rem;
            font-weight: 600; text-transform: uppercase; margin-left: 10px;
        }
        .due-overdue { background: #ffebee; color: #c62828; animation: pulse 2s infinite; }
        .due-today { background: #fff3e0; color: #ef6c00; }
        .due-soon { background: #f3e5f5; color: #7b1fa2; }

        @keyframes pulse { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.05); } 
            100% { transform: scale(1); } 
        }

        .task-form {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            padding: 30px; 
            margin-bottom: 30px; 
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .task-form .section-title {
            color: white; 
            border-bottom: 3px solid rgba(255, 255, 255, 0.3);
            font-size: 1.8rem; 
            margin-bottom: 25px;
        }

        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600;
            color: white; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px; 
            font-size: 16px; 
            background: rgba(255, 255, 255, 0.1);
            color: white; 
            transition: all 0.3s; 
            backdrop-filter: blur(10px);
        }

        .form-group input::placeholder, .form-group textarea::placeholder { 
            color: rgba(255, 255, 255, 0.7); 
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none; 
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.2); 
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }

        .form-group select option { background: #2c3e50; color: white; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        .form-group input[type="checkbox"] {
            width: auto !important;
            margin-right: 10px;
            transform: scale(1.2);
        }

        .btn {
            padding: 12px 25px; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px;
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            text-decoration: none;
            display: inline-block; 
            text-align: center;
        }

        .btn-primary {
            background: rgba(255, 255, 255, 0.9); 
            color: #667eea;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .btn-primary:hover { 
            background: white; 
            transform: translateY(-2px); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
        }

        .btn-success {
            background: rgba(86, 171, 47, 0.9); 
            color: white; 
            margin-left: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .btn-success:hover { 
            background: #56ab2f; 
            transform: translateY(-2px); 
            box-shadow: 0 10px 25px rgba(86, 171, 47, 0.3); 
        }

        .btn-purple {
            background: rgba(155, 89, 182, 0.9); 
            color: white; 
            margin-left: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .btn-purple:hover { 
            background: #9b59b6; 
            transform: translateY(-2px); 
            box-shadow: 0 10px 25px rgba(155, 89, 182, 0.3); 
        }

        .notifications-section {
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 10px;
            margin-bottom: 20px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .notification-item {
            display: flex; 
            align-items: center; 
            padding: 12px 15px; 
            background: white;
            border-radius: 8px; 
            margin-bottom: 10px; 
            border-left: 4px solid #667eea; 
            transition: transform 0.2s;
        }
        .notification-item:hover { transform: translateX(5px); }

        .notification-icon { font-size: 1.5rem; margin-right: 15px; }
        .notification-content { flex: 1; }
        .notification-title { font-weight: 600; color: #2c3e50; margin-bottom: 2px; }
        .notification-text { color: #7f8c8d; font-size: 0.9rem; }
        .notification-time { color: #bdc3c7; font-size: 0.8rem; margin-left: 15px; }

        .section-title {
            font-size: 1.5rem; 
            color: #2c3e50; 
            margin-bottom: 20px;
            padding-bottom: 10px; 
            border-bottom: 3px solid #667eea;
        }

        .tasks-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap: 20px; 
        }

        .task-card {
            background: white; 
            border-radius: 10px; 
            padding: 20px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 5px solid #667eea; 
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .task-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 30px rgba(0,0,0,0.15); 
        }

        .task-title { 
            font-size: 1.2rem; 
            font-weight: 600; 
            color: #2c3e50; 
            margin-bottom: 10px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .task-description { 
            color: #7f8c8d; 
            margin-bottom: 15px; 
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .task-meta {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 15px; 
            font-size: 0.9rem;
        }
        .task-assignee { color: #34495e; font-weight: 500; }
        .task-date { color: #7f8c8d; }

        .task-priority {
            padding: 4px 12px; 
            border-radius: 15px; 
            font-size: 0.8rem;
            font-weight: 600; 
            text-transform: uppercase;
        }
        .priority-alta { background: #ffebee; color: #c62828; }
        .priority-media { background: #fff3e0; color: #ef6c00; }
        .priority-bassa { background: #e8f5e8; color: #2e7d32; }

        .task-status { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-bottom: 15px;
        }
        .status-select {
            padding: 8px 12px; 
            border: 2px solid #e9ecef; 
            border-radius: 6px;
            font-size: 14px; 
            cursor: pointer; 
            transition: border-color 0.3s;
        }
        .status-select:focus { outline: none; border-color: #667eea; }

        .task-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-edit {
            background: #3498db;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-small:hover {
            transform: scale(1.05);
        }

        .stats-section {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; 
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            padding: 20px; 
            border-radius: 10px; 
            text-align: center;
        }
        .stat-number { font-size: 2.5rem; font-weight: 300; margin-bottom: 5px; }
        .stat-label { opacity: 0.9; font-size: 0.9rem; }

        .empty-state { 
            text-align: center; 
            padding: 60px 20px; 
            color: #7f8c8d; 
            grid-column: 1 / -1;
        }

        .tag-option {
            transition: all 0.3s;
            user-select: none;
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.8rem;
            margin: 4px;
        }
        .tag-option:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .tag-option.selected {
            box-shadow: 0 0 0 3px rgba(255,255,255,0.5);
            transform: scale(1.1);
            background: rgba(255,255,255,0.3);
        }

        .filters-bar {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .btn-view {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-view.active {
            background: #667eea !important;
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }

        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .tasks-grid { grid-template-columns: 1fr; }
            .stats-section { grid-template-columns: repeat(2, 1fr); }
            .alert-container { left: 20px; right: 20px; max-width: none; }
            .company-logo { flex-direction: column; gap: 10px; }
            .logo-text { font-size: 2.2rem; }
            .task-form { padding: 20px; }
            .task-form .section-title { font-size: 1.4rem; }
            .filters-bar { flex-direction: column; align-items: flex-start; }
        }

        /* Status per GitHub Pages */
        .status-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="company-logo">
                <span class="logo-text gruppo-text">GRUPPO</span>
                <span class="logo-text visconti-text">VISCONTI</span>
            </div>
            <div class="tagline">Join the ReEvolution</div>
            <h1>📋 Gestore Compiti</h1>
            <p>Organizza, monitora e traccia tutti i tuoi compiti in modo efficiente</p>
        </div>

        <div class="main-content">
            <div class="alert-container" id="alertContainer"></div>

            <!-- Form nuovo compito -->
            <div class="task-form">
                <h2 class="section-title">➕ Nuovo Compito</h2>
                <p style="margin-bottom: 20px; opacity: 0.9; font-size: 1.1rem;">
                    🚀 Crea rapidamente un nuovo compito per il team
                </p>
                <form id="taskForm">
                    <div class="form-group">
                        <label for="taskTitle">Titolo Compito *</label>
                        <input type="text" id="taskTitle" required placeholder="Es: Preparare presentazione Q4" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDescription">Descrizione</label>
                        <textarea id="taskDescription" placeholder="Descrivi dettagliatamente il compito da svolgere..." maxlength="500"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskAssignee">Assegnato a *</label>
                            <select id="taskAssignee" required multiple style="height: auto; min-height: 80px;">
                                <option value="Lucianodp74">👤 LUCIANO</option>
                                <option value="ANTONIO">👤 ANTONIO</option>
                                <option value="Luigiambrosino">👤 LUIGI</option>
                                <option value="DARIO">👤 DARIO</option>
                                <option value="NOEMI">👤 NOEMI</option>
                                <option value="VINCENZO">👤 VINCENZO</option>
                                <option value="ROBERTO">👤 ROBERTO</option>
                                <option value="MARIANO">👤 MARIANO</option>
                            </select>
                            <small style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">Tieni premuto Ctrl per selezionare più persone</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="taskPriority">Priorità</label>
                            <select id="taskPriority">
                                <option value="bassa">🟢 Bassa</option>
                                <option value="media" selected>🟡 Media</option>
                                <option value="alta">🔴 Alta</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Tags</label>
                        <div id="taskTags" style="margin-bottom: 10px;">
                            <span class="tag-option" data-tag="Urgente">🔥 Urgente</span>
                            <span class="tag-option" data-tag="Cliente">👥 Cliente</span>
                            <span class="tag-option" data-tag="Interno">🏢 Interno</span>
                            <span class="tag-option" data-tag="Marketing">📢 Marketing</span>
                            <span class="tag-option" data-tag="Sviluppo">💻 Sviluppo</span>
                            <span class="tag-option" data-tag="Vendite">💰 Vendite</span>
                        </div>
                        <input type="hidden" id="selectedTags" value="">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskDueDate">Scadenza</label>
                            <input type="date" id="taskDueDate">
                        </div>
                        
                        <div class="form-group">
                            <label for="taskStatus">Stato Iniziale</label>
                            <select id="taskStatus">
                                <option value="da-iniziare" selected>📋 Da Iniziare</option>
                                <option value="in-corso">🚀 In Corso</option>
                                <option value="in-revisione">👁️ In Revisione</option>
                                <option value="completato">✅ Completato</option>
                                <option value="in-pausa">⏸️ In Pausa</option>
                                <option value="annullato">❌ Annullato</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="enableReminder">
                            <span>🔔 Attiva promemoria automatico (1 giorno prima della scadenza)</span>
                        </label>
                    </div>
                    
                    <div style="margin-top: 25px; display: flex; gap: 15px; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-primary" style="flex: 1; min-width: 200px;">
                            ➕ Aggiungi Compito
                        </button>
                        
                        <button type="button" class="btn btn-purple" onclick="resetForm()" style="flex: 0 0 auto;">
                            🔄 Reset Form
                        </button>
                        
                        <button type="button" class="btn btn-success" onclick="setupGitHubIntegration()" style="flex: 0 0 auto;">
                            🐙 GitHub Sync
                        </button>
                        
                        <button type="button" class="btn btn-success" onclick="shareData()" style="flex: 0 0 auto;">
                            🔗 Condividi Link
                        </button>
                        
                        <button type="button" class="btn btn-success" onclick="exportData()" style="flex: 0 0 auto;">
                            📊 Export CSV
                        </button>
                        
                        <button type="button" class="btn btn-purple" onclick="testStorage()" style="flex: 0 0 auto;">
                            🔧 Test Sistema
                        </button>
                        
                        <button type="button" class="btn btn-purple" onclick="addDemoData()" style="flex: 0 0 auto;">
                            🎲 Dati Demo
                        </button>
                        
                        <button type="button" class="btn btn-purple" onclick="clearAllData()" style="flex: 0 0 auto;">
                            🗑️ Reset
                        </button>
                    </div>
                </form>
            </div>

            <!-- Filtri -->
            <div class="filters-bar">
                <div style="font-weight: 600; color: #2c3e50;">🔍 Filtri:</div>
                
                <select id="filterAssignee" onchange="applyFilters()">
                    <option value="tutti">👥 Tutti gli assegnatari</option>
                    <option value="LUCIANO">👤 LUCIANO</option>
                    <option value="ANTONIO">👤 ANTONIO</option>
                    <option value="LUIGI">👤 LUIGI</option>
                    <option value="DARIO">👤 DARIO</option>
                    <option value="NOEMI">👤 NOEMI</option>
                    <option value="VINCENZO">👤 VINCENZO</option>
                    <option value="ROBERTO">👤 ROBERTO</option>
                    <option value="MARIANO">👤 MARIANO</option>
                </select>
                
                <select id="filterPriority" onchange="applyFilters()">
                    <option value="tutte">🎯 Tutte le priorità</option>
                    <option value="alta">🔴 Alta</option>
                    <option value="media">🟡 Media</option>
                    <option value="bassa">🟢 Bassa</option>
                </select>
                
                <select id="filterStatus" onchange="applyFilters()">
                    <option value="tutti">📋 Tutti gli stati</option>
                    <option value="da-iniziare">📋 Da Iniziare</option>
                    <option value="in-corso">🚀 In Corso</option>
                    <option value="completato">✅ Completato</option>
                    <option value="in-pausa">⏸️ In Pausa</option>
                </select>
                
                <button onclick="clearFilters()" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                    🗑️ Reset Filtri
                </button>
            </div>

            <!-- Stats -->
            <div class="stats-section">
                <div class="stat-card">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">Totale Compiti</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="inProgressTasks">0</div>
                    <div class="stat-label">In Corso</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">Completati</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingTasks">0</div>
                    <div class="stat-label">Da Iniziare</div>
                </div>
            </div>

            <!-- Notifiche -->
            <div class="notifications-section">
                <h2 class="section-title">🔔 Notifiche Recenti</h2>
                <div id="notificationsList">
                    <div class="empty-state" style="padding: 20px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">🔔</div>
                        <p style="margin: 0;">Nessuna notifica al momento</p>
                    </div>
                </div>
            </div>

            <!-- Tasks -->
            <div class="tasks-section">
                <h2 class="section-title">📌 Compiti Attivi</h2>
                <div class="tasks-grid" id="tasksGrid">
                    <div class="empty-state">
                        <div style="font-size: 4rem; margin-bottom: 20px;">📋</div>
                        <h3>Nessun compito presente</h3>
                        <p>Aggiungi il tuo primo compito utilizzando il form sopra</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Indicator -->
    <div class="status-indicator" id="statusIndicator">
        🔄 Caricamento...
    </div>

    <script>
        // Task Manager Gruppo Visconti - GitHub Pages Compatible
        console.log('🚀 Avvio Task Manager Gruppo Visconti v2.0');
        
        // Configurazione globale
        var taskManager = {
            tasks: [],
            notifications: [],
            alertCounter: 0,
            currentUser: 'Admin',
            teamMembers: ['LUCIANO', 'ANTONIO', 'LUIGI', 'DARIO', 'NOEMI', 'VINCENZO', 'ROBERTO', 'MARIANO'],
            availableTags: ['Urgente', 'Cliente', 'Interno', 'Marketing', 'Sviluppo', 'Vendite'],
            filters: {
                assignee: 'tutti',
                priority: 'tutte',
                status: 'tutti',
                tags: []
            },
            taskStates: {
                'da-iniziare': { label: '📋 Da Iniziare', class: 'status-da-iniziare' },
                'in-corso': { label: '🚀 In Corso', class: 'status-in-corso' },
                'in-revisione': { label: '👁️ In Revisione', class: 'status-in-revisione' },
                'completato': { label: '✅ Completato', class: 'status-completato' },
                'in-pausa': { label: '⏸️ In Pausa', class: 'status-in-pausa' },
                'annullato': { label: '❌ Annullato', class: 'status-annullato' }
            },
            priorities: {
                'alta': { label: '🔴 Alta', class: 'priority-alta' },
                'media': { label: '🟡 Media', class: 'priority-media' },
                'bassa': { label: '🟢 Bassa', class: 'priority-bassa' }
            },
            storageAvailable: false
        };

        // Utility Functions
        function generateId() {
            return 'task_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                var date = new Date(dateString);
                return date.toLocaleDateString('it-IT');
            } catch (e) {
                return dateString;
            }
        }

        function getTimeAgo(timestamp) {
            try {
                var now = new Date();
                var time = new Date(timestamp);
                var diffMs = now - time;
                var diffMins = Math.floor(diffMs / 60000);
                var diffHours = Math.floor(diffMs / 3600000);
                var diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'Ora';
                if (diffMins < 60) return diffMins + 'm fa';
                if (diffHours < 24) return diffHours + 'h fa';
                return diffDays + 'g fa';
            } catch (e) {
                return 'N/A';
            }
        }

        function getDueBadge(dueDate) {
            if (!dueDate) return '';
            
            try {
                var today = new Date();
                today.setHours(0, 0, 0, 0);
                var due = new Date(dueDate);
                due.setHours(0, 0, 0, 0);
                var diffTime = due - today;
                var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 0) {
                    return '<span class="due-badge due-overdue">Scaduto</span>';
                } else if (diffDays === 0) {
                    return '<span class="due-badge due-today">Oggi</span>';
                } else if (diffDays <= 3) {
                    return '<span class="due-badge due-soon">' + diffDays + 'g</span>';
                }
                return '';
            } catch (e) {
                return '';
            }
        }

        // Storage System - GitHub Pages Compatible
        function testStorage() {
            console.log('🔍 DIAGNOSTICA SISTEMA:');
            updateStatus('🔧 Testing storage...');
            
            var results = {
                localStorage: false,
                sessionStorage: false,
                url: window.location.href,
                protocol: window.location.protocol,
                browser: navigator.userAgent.substring(0, 50) + '...'
            };

            // Test localStorage
            try {
                if (typeof Storage !== "undefined" && window.localStorage) {
                    localStorage.setItem('test', 'ok');
                    var result = localStorage.getItem('test');
                    localStorage.removeItem('test');
                    results.localStorage = (result === 'ok');
                }
            } catch (e) {
                console.warn('localStorage non disponibile:', e.message);
            }

            // Test sessionStorage
            try {
                if (typeof Storage !== "undefined" && window.sessionStorage) {
                    sessionStorage.setItem('test', 'ok');
                    var result = sessionStorage.getItem('test');
                    sessionStorage.removeItem('test');
                    results.sessionStorage = (result === 'ok');
                }
            } catch (e) {
                console.warn('sessionStorage non disponibile:', e.message);
            }

            console.log('✅ localStorage:', results.localStorage ? 'FUNZIONA' : 'NON DISPONIBILE');
            console.log('✅ sessionStorage:', results.sessionStorage ? 'FUNZIONA' : 'NON DISPONIBILE');
            console.log('🌐 URL:', results.url);
            console.log('🔒 Protocollo:', results.protocol);
            
            taskManager.storageAvailable = results.localStorage || results.sessionStorage;
            
            var statusMsg = taskManager.storageAvailable ? '✅ Storage OK' : '⚠️ Storage limitato';
            updateStatus(statusMsg);
            
            showAlert('info', 'Test Sistema', 
                'localStorage: ' + (results.localStorage ? '✅' : '❌') + 
                ' | sessionStorage: ' + (results.sessionStorage ? '✅' : '❌') +
                ' | Protocollo: ' + results.protocol
            );
            
            return results;
        }

        function saveData() {
            try {
                var data = {
                    tasks: taskManager.tasks,
                    notifications: taskManager.notifications,
                    lastSaved: new Date().toISOString(),
                    version: '2.0'
                };
                
                var jsonData = JSON.stringify(data);
                var saved = false;
                
                // Prova localStorage prima
                if (typeof Storage !== "undefined" && window.localStorage) {
                    try {
                        localStorage.setItem('gruppoViscontiTasks_v2', jsonData);
                        console.log('✅ Dati salvati in localStorage (' + jsonData.length + ' chars)');
                        saved = true;
                    } catch (e) {
                        console.warn('localStorage fallito:', e.message);
                    }
                }
                
                // Fallback a sessionStorage
                if (!saved && typeof Storage !== "undefined" && window.sessionStorage) {
                    try {
                        sessionStorage.setItem('gruppoViscontiTasks_v2', jsonData);
                        console.log('✅ Dati salvati in sessionStorage (' + jsonData.length + ' chars)');
                        saved = true;
                    } catch (e) {
                        console.warn('sessionStorage fallito:', e.message);
                    }
                }
                
                // Fallback finale: memoria globale
                if (!saved) {
                    window.tempTaskData = data;
                    console.log('⚠️ Dati salvati solo in memoria (temporaneo)');
                    showAlert('warning', 'Avviso', 'I dati sono salvati solo in memoria e saranno persi al refresh');
                }
                
                updateStatus(saved ? '✅ Salvato' : '⚠️ Solo memoria');
                return saved;
                
            } catch (error) {
                console.error('❌ Errore salvataggio:', error);
                updateStatus('❌ Errore salvataggio');
                showAlert('danger', 'Errore Salvataggio', 'Impossibile salvare i dati: ' + error.message);
                return false;
            }
        }

        function loadData() {
            try {
                var savedData = null;
                var source = 'nessuna';
                
                // Prova localStorage
                if (typeof Storage !== "undefined" && window.localStorage) {
                    savedData = localStorage.getItem('gruppoViscontiTasks_v2');
                    if (savedData) source = 'localStorage';
                }
                
                // Prova sessionStorage
                if (!savedData && typeof Storage !== "undefined" && window.sessionStorage) {
                    savedData = sessionStorage.getItem('gruppoViscontiTasks_v2');
                    if (savedData) source = 'sessionStorage';
                }
                
                // Prova memoria globale
                if (!savedData && window.tempTaskData) {
                    savedData = JSON.stringify(window.tempTaskData);
                    if (savedData) source = 'memoria';
                }
                
                if (savedData) {
                    var data = JSON.parse(savedData);
                    taskManager.tasks = Array.isArray(data.tasks) ? data.tasks : [];
                    taskManager.notifications = Array.isArray(data.notifications) ? data.notifications : [];
                    
                    console.log('✅ Dati caricati da ' + source + ': ' + taskManager.tasks.length + ' tasks, ' + taskManager.notifications.length + ' notifiche');
                    updateStatus('✅ Caricato da ' + source);
                    return true;
                }
                
                console.log('ℹ️ Nessun dato salvato trovato');
                updateStatus('🆕 Primo avvio');
                return false;
                
            } catch (error) {
                console.error('❌ Errore caricamento:', error);
                taskManager.tasks = [];
                taskManager.notifications = [];
                updateStatus('❌ Errore caricamento');
                return false;
            }
        }

        // Alert System
        function showAlert(type, title, message, duration) {
            duration = duration || 5000;
            taskManager.alertCounter++;
            var alertId = 'alert-' + taskManager.alertCounter;
            
            var alertElement = document.createElement('div');
            alertElement.id = alertId;
            alertElement.className = 'alert alert-' + type;
            alertElement.innerHTML = 
                '<button class="alert-close" onclick="closeAlert(\'' + alertId + '\')">&times;</button>' +
                '<div class="alert-title">' + title + '</div>' +
                '<div class="alert-message">' + message + '</div>';
            
            var container = document.getElementById('alertContainer');
            if (container) {
                container.appendChild(alertElement);
                
                setTimeout(function() {
                    closeAlert(alertId);
                }, duration);
            }
        }

        function closeAlert(alertId) {
            var alert = document.getElementById(alertId);
            if (alert) {
                alert.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(function() {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }
        }

        function updateStatus(message) {
            var indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.textContent = message;
            }
        }

        // Notification System
        function addNotification(type, title, message, taskId) {
            var notification = {
                id: generateId(),
                type: type,
                title: title,
                message: message,
                taskId: taskId || null,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            taskManager.notifications.unshift(notification);
            
            // Mantieni solo le ultime 20 notifiche
            if (taskManager.notifications.length > 20) {
                taskManager.notifications = taskManager.notifications.slice(0, 20);
            }
            
            saveData();
            renderNotifications();
            
            var icons = {
                'deadline': '⏰',
                'overdue': '🚨',
                'completed': '✅',
                'assigned': '📋',
                'reminder': '🔔',
                'info': 'ℹ️'
            };
            
            var alertType = type === 'overdue' ? 'danger' : 
                             type === 'deadline' ? 'warning' : 
                             type === 'completed' ? 'success' : 'info';
            
            showAlert(alertType, (icons[type] || '🔔') + ' ' + title, message);
        }

        function renderNotifications() {
            var container = document.getElementById('notificationsList');
            if (!container) return;
            
            if (taskManager.notifications.length === 0) {
                container.innerHTML = 
                    '<div class="empty-state" style="padding: 20px;">' +
                    '<div style="font-size: 2rem; margin-bottom: 10px;">🔔</div>' +
                    '<p style="margin: 0;">Nessuna notifica al momento</p>' +
                    '</div>';
                return;
            }

            var icons = {
                'deadline': '⏰', 'overdue': '🚨', 'completed': '✅',
                'assigned': '📋', 'reminder': '🔔', 'info': 'ℹ️'
            };

            var html = '';
            var displayNotifications = taskManager.notifications.slice(0, 5);
            
            for (var i = 0; i < displayNotifications.length; i++) {
                var notif = displayNotifications[i];
                html += 
                    '<div class="notification-item">' +
                    '<div class="notification-icon">' + (icons[notif.type] || '🔔') + '</div>' +
                    '<div class="notification-content">' +
                    '<div class="notification-title">' + notif.title + '</div>' +
                    '<div class="notification-text">' + notif.message + '</div>' +
                    '</div>' +
                    '<div class="notification-time">' + getTimeAgo(notif.timestamp) + '</div>' +
                    '</div>';
            }
            
            container.innerHTML = html;
        }

        // Tag System
        function initializeTags() {
            var tagOptions = document.querySelectorAll('.tag-option');
            for (var i = 0; i < tagOptions.length; i++) {
                tagOptions[i].addEventListener('click', function() {
                    this.classList.toggle('selected');
                    updateSelectedTags();
                });
            }
        }

        function updateSelectedTags() {
            var selectedTags = [];
            var tagOptions = document.querySelectorAll('.tag-option.selected');
            for (var i = 0; i < tagOptions.length; i++) {
                selectedTags.push(tagOptions[i].getAttribute('data-tag'));
            }
            document.getElementById('selectedTags').value = selectedTags.join(',');
        }

        // GITHUB ISSUES INTEGRATION - Sincronizzazione in tempo reale
        var GITHUB_CONFIG = {
            enabled: false,
            token: null,
            owner: 'Lucianodp74',
            repo: 'Gruppo-Visconti',
            apiUrl: 'https://api.github.com'
        };

        function setupGitHubIntegration() {
            var modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 2000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            var modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; border-radius: 15px; padding: 30px; 
                max-width: 700px; width: 95%; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                max-height: 85vh; overflow-y: auto;
            `;
            
            modalContent.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #2c3e50;">🐙 GitHub Issues Integration</h3>
                
                <div style="background: #f6f8fa; border: 2px solid #0366d6; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>🌟 VANTAGGI GITHUB ISSUES:</strong><br><br>
                    ✅ <strong>Sincronizzazione PERFETTA</strong> - Tempo reale su tutti i dispositivi<br>
                    ✅ <strong>App mobile GitHub</strong> - Tutti possono vedere i compiti<br>
                    ✅ <strong>Notifiche automatiche</strong> - Email/push quando qualcosa cambia<br>
                    ✅ <strong>Completamente GRATUITO</strong> - Nessun costo aggiuntivo<br>
                    ✅ <strong>Backup automatico</strong> - I dati sono sicuri su GitHub<br>
                    ✅ <strong>Collaborazione avanzata</strong> - Commenti, menzioni, labels
                </div>

                <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>📝 COME FUNZIONA:</strong><br><br>
                    • <strong>Ogni compito</strong> = 1 GitHub Issue<br>
                    • <strong>Titolo compito</strong> = Titolo Issue<br>
                    • <strong>Descrizione</strong> = Corpo Issue<br>
                    • <strong>Tags</strong> = Labels GitHub<br>
                    • <strong>Assegnatari</strong> = Assignees GitHub<br>
                    • <strong>Stati</strong> = Issue aperta/chiusa + labels
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">🔑 GitHub Personal Access Token:</label>
                    <input type="password" id="githubToken" placeholder="ghp_..." 
                           style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 12px;">
                    <small style="color: #7f8c8d;">Il token che hai appena creato (inizia con ghp_...)</small>
                </div>

                <div style="background: #e8f5e8; border: 2px solid #28a745; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>🎯 REPOSITORY CONFIGURATO:</strong><br>
                    📂 <strong>Owner:</strong> Lucianodp74<br>
                    📁 <strong>Repository:</strong> Gruppo-Visconti<br>
                    🔗 <strong>URL:</strong> https://github.com/Lucianodp74/Gruppo-Visconti
                </div>

                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="testGitHubConnection()" style="background: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        🔍 Test Connessione
                    </button>
                    <button onclick="activateGitHubSync()" style="background: #0366d6; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        🚀 Attiva Sincronizzazione
                    </button>
                    <button onclick="syncExistingTasks()" style="background: #6f42c1; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        📤 Sincronizza Compiti Esistenti
                    </button>
                    <button onclick="closeGitHubModal()" style="background: #6a737d; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer;">
                        ❌ Chiudi
                    </button>
                </div>

                <div style="margin-top: 20px; font-size: 12px; color: #7f8c8d;">
                    <strong>💡 Suggerimento:</strong> Una volta attivata la sincronizzazione, ogni compito che crei/modifichi 
                    nell'app verrà automaticamente sincronizzato con GitHub Issues. Il team potrà vedere tutto in tempo reale!
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            modal.id = 'githubModal';
        }

        function testGitHubConnection() {
            var token = document.getElementById('githubToken').value.trim();
            
            if (!token || !token.startsWith('ghp_')) {
                showAlert('warning', 'Token Mancante', 'Inserisci il GitHub Personal Access Token');
                return;
            }
            
            showAlert('info', 'Test in Corso', 'Sto testando la connessione a GitHub...');
            
            fetch(`${GITHUB_CONFIG.apiUrl}/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'X-GitHub-Api-Version': '2022-11-28'
                }
            })
            .then(function(response) {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('HTTP ' + response.status);
                }
            })
            .then(function(data) {
                showAlert('success', 'Connessione Riuscita! 🎉', 
                    'GitHub repository "' + data.name + '" raggiunto con successo. Permessi verificati!');
                
                // Salva temporaneamente il token per i prossimi test
                GITHUB_CONFIG.token = token;
            })
            .catch(function(error) {
                console.error('Errore connessione GitHub:', error);
                showAlert('danger', 'Errore Connessione', 
                    'Impossibile connettersi a GitHub. Verifica il token e i permessi. Errore: ' + error.message);
            });
        }

        function activateGitHubSync() {
            var token = document.getElementById('githubToken').value.trim();
            
            if (!token || !token.startsWith('ghp_')) {
                showAlert('danger', 'Errore', 'Inserisci prima il GitHub Personal Access Token');
                return;
            }
            
            // Salva la configurazione
            GITHUB_CONFIG.enabled = true;
            GITHUB_CONFIG.token = token;
            
            try {
                var storage = window.localStorage || window.sessionStorage;
                if (storage) {
                    storage.setItem('githubConfig', JSON.stringify({
                        enabled: true,
                        token: token, // In produzione, questo dovrebbe essere crittografato
                        owner: GITHUB_CONFIG.owner,
                        repo: GITHUB_CONFIG.repo
                    }));
                }
            } catch (e) {
                console.warn('Impossibile salvare configurazione GitHub');
            }
            
            closeGitHubModal();
            
            showAlert('success', 'GitHub Sync Attivato! 🚀', 
                'La sincronizzazione con GitHub Issues è ora attiva. Tutti i nuovi compiti verranno creati come Issues!');
            
            updateStatus('🐙 GitHub connesso');
            
            // Mostra pulsante per sincronizzare compiti esistenti
            setTimeout(function() {
                if (taskManager.tasks.length > 0) {
                    var sync = confirm('Hai ' + taskManager.tasks.length + ' compiti locali.\n\n' +
                                      'Vuoi sincronizzarli con GitHub Issues?\n\n' +
                                      '✅ SÌ = Crea Issues per tutti i compiti esistenti\n' +
                                      '❌ NO = Solo i nuovi compiti saranno sincronizzati');
                    if (sync) {
                        syncExistingTasks();
                    }
                }
            }, 2000);
        }

        function syncExistingTasks() {
            if (!GITHUB_CONFIG.enabled || !GITHUB_CONFIG.token) {
                showAlert('warning', 'Configurazione Mancante', 'Attiva prima la sincronizzazione GitHub');
                return;
            }
            
            var tasksToSync = taskManager.tasks.filter(function(task) {
                return !task.githubIssueId; // Solo tasks che non hanno ancora un Issue
            });
            
            if (tasksToSync.length === 0) {
                showAlert('info', 'Niente da Sincronizzare', 'Tutti i compiti sono già sincronizzati con GitHub');
                return;
            }
            
            showAlert('info', 'Sincronizzazione in Corso', 
                'Sto creando ' + tasksToSync.length + ' GitHub Issues...');
            
            var completed = 0;
            var total = tasksToSync.length;
            
            for (var i = 0; i < tasksToSync.length; i++) {
                createGitHubIssue(tasksToSync[i], function(success, task, issueData) {
                    completed++;
                    
                    if (success && issueData) {
                        // Aggiorna il task con l'ID dell'Issue
                        task.githubIssueId = issueData.number;
                        task.githubUrl = issueData.html_url;
                        saveData();
                    }
                    
                    if (completed === total) {
                        var successCount = taskManager.tasks.filter(function(t) { return t.githubIssueId; }).length;
                        showAlert('success', 'Sincronizzazione Completata! 🎉', 
                            successCount + ' compiti sono ora sincronizzati con GitHub Issues');
                        
                        renderTasks(); // Aggiorna UI
                    }
                });
            }
        }

        function createGitHubIssue(task, callback) {
            if (!GITHUB_CONFIG.enabled || !GITHUB_CONFIG.token) {
                callback(false, task, null);
                return;
            }
            
            var assignees = Array.isArray(task.assignee) ? task.assignee : [task.assignee];
            var githubAssignees = assignees.map(function(name) {
                // Mappa i nomi ai username GitHub se necessario
                var mapping = {
                    'LUCIANO': 'Lucianodp74', // Aggiorna con i veri username
                    // Aggiungi altri mappings qui
                };
                return mapping[name] || name.toLowerCase();
            }).filter(function(username) {
                return username && username !== 'admin';
            });
            
            var labels = [];
            if (task.priority === 'alta') labels.push('priority: high');
            if (task.priority === 'media') labels.push('priority: medium');
            if (task.priority === 'bassa') labels.push('priority: low');
            
            if (task.tags) {
                for (var i = 0; i < task.tags.length; i++) {
                    labels.push(task.tags[i].toLowerCase());
                }
            }
            
            labels.push('task-manager'); // Label per identificare gli Issues creati dall'app
            
            var issueBody = task.description || 'Nessuna descrizione';
            issueBody += '\n\n---\n';
            issueBody += '**📋 Dettagli Compito:**\n';
            issueBody += '- 🎯 **Priorità:** ' + taskManager.priorities[task.priority].label + '\n';
            issueBody += '- 📅 **Scadenza:** ' + (task.dueDate ? formatDate(task.dueDate) : 'Nessuna') + '\n';
            issueBody += '- 🏷️ **Tags:** ' + (task.tags ? task.tags.join(', ') : 'Nessuno') + '\n';
            issueBody += '- 📱 **Creato da:** Task Manager Gruppo Visconti\n';
            issueBody += '- 🕐 **Data creazione:** ' + formatDate(task.createdAt);
            
            var issueData = {
                title: task.title,
                body: issueBody,
                labels: labels,
                assignees: githubAssignees
            };
            
            fetch(`${GITHUB_CONFIG.apiUrl}/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/issues`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json',
                    'X-GitHub-Api-Version': '2022-11-28'
                },
                body: JSON.stringify(issueData)
            })
            .then(function(response) {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('HTTP ' + response.status);
                }
            })
            .then(function(data) {
                console.log('✅ GitHub Issue creato:', data.number, data.title);
                callback(true, task, data);
            })
            .catch(function(error) {
                console.error('❌ Errore creazione Issue:', error);
                callback(false, task, null);
            });
        }

        function updateGitHubIssue(task, callback) {
            if (!GITHUB_CONFIG.enabled || !GITHUB_CONFIG.token || !task.githubIssueId) {
                if (callback) callback(false, task);
                return;
            }
            
            var assignees = Array.isArray(task.assignee) ? task.assignee : [task.assignee];
            var githubAssignees = assignees.map(function(name) {
                var mapping = {
                    'LUCIANO': 'Lucianodp74',
                };
                return mapping[name] || name.toLowerCase();
            }).filter(function(username) {
                return username && username !== 'admin';
            });
            
            var labels = ['task-manager'];
            if (task.priority === 'alta') labels.push('priority: high');
            if (task.priority === 'media') labels.push('priority: medium');
            if (task.priority === 'bassa') labels.push('priority: low');
            
            if (task.tags) {
                for (var i = 0; i < task.tags.length; i++) {
                    labels.push(task.tags[i].toLowerCase());
                }
            }
            
            var issueBody = task.description || 'Nessuna descrizione';
            issueBody += '\n\n---\n';
            issueBody += '**📋 Dettagli Compito:**\n';
            issueBody += '- 🎯 **Priorità:** ' + taskManager.priorities[task.priority].label + '\n';
            issueBody += '- 📊 **Stato:** ' + taskManager.taskStates[task.status].label + '\n';
            issueBody += '- 📅 **Scadenza:** ' + (task.dueDate ? formatDate(task.dueDate) : 'Nessuna') + '\n';
            issueBody += '- 🏷️ **Tags:** ' + (task.tags ? task.tags.join(', ') : 'Nessuno') + '\n';
            issueBody += '- 📱 **Ultima modifica:** ' + formatDate(task.updatedAt);
            
            var issueUpdate = {
                title: task.title,
                body: issueBody,
                labels: labels,
                assignees: githubAssignees,
                state: task.status === 'completato' ? 'closed' : 'open'
            };
            
            fetch(`${GITHUB_CONFIG.apiUrl}/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/issues/${task.githubIssueId}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json',
                    'X-GitHub-Api-Version': '2022-11-28'
                },
                body: JSON.stringify(issueUpdate)
            })
            .then(function(response) {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('HTTP ' + response.status);
                }
            })
            .then(function(data) {
                console.log('✅ GitHub Issue aggiornato:', data.number, data.title);
                if (callback) callback(true, task);
            })
            .catch(function(error) {
                console.error('❌ Errore aggiornamento Issue:', error);
                if (callback) callback(false, task);
            });
        }

        function closeGitHubModal() {
            var modal = document.getElementById('githubModal');
            if (modal) {
                modal.remove();
            }
        }

        function loadGitHubConfig() {
            try {
                var storage = window.localStorage || window.sessionStorage;
                if (storage) {
                    var saved = storage.getItem('githubConfig');
                    if (saved) {
                        var config = JSON.parse(saved);
                        GITHUB_CONFIG.enabled = config.enabled;
                        GITHUB_CONFIG.token = config.token;
                        GITHUB_CONFIG.owner = config.owner || 'Lucianodp74';
                        GITHUB_CONFIG.repo = config.repo || 'Gruppo-Visconti';
                        
                        if (GITHUB_CONFIG.enabled) {
                            updateStatus('🐙 GitHub connesso');
                            console.log('✅ GitHub sync attivo');
                        }
                    }
                }
            } catch (e) {
                console.warn('Impossibile caricare configurazione GitHub');
            }
        }
        function openGoogleSheetsGuide() {
            try {
                // Prima esporta i dati
                exportData();
                
                // Poi apri Google Sheets
                setTimeout(function() {
                    window.open('https://sheets.google.com', '_blank');
                    
                    // Mostra istruzioni semplici
                    setTimeout(function() {
                        showAlert('info', '📊 Istruzioni Google Sheets', 
                            '1️⃣ Il file CSV è stato scaricato\n' +
                            '2️⃣ Google Sheets si è aperto\n' +
                            '3️⃣ Crea nuovo foglio "Compiti Gruppo Visconti"\n' +
                            '4️⃣ File → Importa → Seleziona il CSV\n' +
                            '5️⃣ Condividi il foglio con i colleghi', 8000);
                    }, 1000);
                }, 500);
            } catch (error) {
                console.error('Errore Google Sheets:', error);
                showAlert('warning', 'Errore', 'Problema con Google Sheets. Prova il pulsante Export CSV.');
            }
        }



        // Variabile globale per tracciare la modifica
        var editingTaskId = null;

        // Task Management
        function addTask(event) {
            event.preventDefault();
            
            var isEditing = editingTaskId !== null;
            console.log(isEditing ? '🔄 Modifica compito...' : '🔄 Creazione nuovo compito...');
            updateStatus(isEditing ? '✏️ Modifica compito...' : '📝 Creazione compito...');
            
            try {
                // Raccolta dati form
                var title = document.getElementById('taskTitle').value.trim();
                var description = document.getElementById('taskDescription').value.trim();
                
                if (!title) {
                    showAlert('danger', 'Errore', 'Il titolo del compito è obbligatorio');
                    return;
                }
                
                var assigneeSelect = document.getElementById('taskAssignee');
                var selectedAssignees = [];
                for (var i = 0; i < assigneeSelect.options.length; i++) {
                    if (assigneeSelect.options[i].selected) {
                        selectedAssignees.push(assigneeSelect.options[i].value);
                    }
                }
                
                if (selectedAssignees.length === 0) {
                    showAlert('danger', 'Errore', 'Seleziona almeno un assegnatario');
                    return;
                }
                
                var priority = document.getElementById('taskPriority').value;
                var dueDate = document.getElementById('taskDueDate').value;
                var status = document.getElementById('taskStatus').value;
                var selectedTags = document.getElementById('selectedTags').value;
                var enableReminder = document.getElementById('enableReminder').checked;
                
                if (isEditing) {
                    // MODALITÀ MODIFICA: Aggiorna task esistente
                    var taskIndex = -1;
                    var existingTask = null;
                    
                    for (var i = 0; i < taskManager.tasks.length; i++) {
                        if (taskManager.tasks[i].id === editingTaskId) {
                            taskIndex = i;
                            existingTask = taskManager.tasks[i];
                            break;
                        }
                    }
                    
                    if (taskIndex !== -1 && existingTask) {
                        // Aggiorna il task esistente mantenendo ID e data creazione
                        taskManager.tasks[taskIndex] = {
                            id: editingTaskId,
                            title: title,
                            description: description,
                            assignee: selectedAssignees,
                            priority: priority,
                            dueDate: dueDate,
                            status: status,
                            tags: selectedTags ? selectedTags.split(',') : [],
                            enableReminder: enableReminder,
                            createdAt: existingTask.createdAt, // Mantieni data originale
                            updatedAt: new Date().toISOString(),
                            createdBy: existingTask.createdBy
                        };
                        
                        console.log('✏️ Task modificato:', taskManager.tasks[taskIndex]);
                        
                        showAlert('success', 'Compito Aggiornato', 
                            'Il compito "' + title + '" è stato aggiornato con successo');
                        
                        addNotification('info', 'Compito Modificato', 
                            'Aggiornato: "' + title + '"', editingTaskId);
                        
                        updateStatus('✅ Compito aggiornato');
                        
                    } else {
                        showAlert('danger', 'Errore', 'Compito da modificare non trovato');
                        return;
                    }
                    
                } else {
                    // MODALITÀ CREAZIONE: Nuovo task
                    var task = {
                        id: generateId(),
                        title: title,
                        description: description,
                        assignee: selectedAssignees,
                        priority: priority,
                        dueDate: dueDate,
                        status: status,
                        tags: selectedTags ? selectedTags.split(',') : [],
                        enableReminder: enableReminder,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        createdBy: taskManager.currentUser
                    };
                    
                    console.log('📋 Task creato:', task);
                    
                    // Aggiungi alla lista
                    taskManager.tasks.push(task);
                    console.log('📊 Totale tasks:', taskManager.tasks.length);
                    
                    showAlert('success', 'Compito Creato', 
                        'Il compito "' + title + '" è stato creato con successo');
                    
                    addNotification('assigned', 'Nuovo Compito', 
                        'Creato: "' + title + '" per ' + selectedAssignees.join(', '), task.id);
                    
                    updateStatus('✅ Compito creato');
                }
                
                // Salvataggio con sincronizzazione GitHub
                var saved = saveData();
                
                // Se GitHub sync è attivo, crea anche l'Issue
                if (GITHUB_CONFIG.enabled && !isEditing) {
                    createGitHubIssue(task, function(success, createdTask, issueData) {
                        if (success && issueData) {
                            task.githubIssueId = issueData.number;
                            task.githubUrl = issueData.html_url;
                            saveData(); // Salva di nuovo con l'ID dell'Issue
                            
                            showAlert('success', 'Compito Sincronizzato! 🐙', 
                                'Compito creato e sincronizzato con GitHub Issue #' + issueData.number);
                        }
                    });
                } else if (GITHUB_CONFIG.enabled && isEditing) {
                    // Aggiorna l'Issue esistente
                    updateGitHubIssue(task, function(success) {
                        if (success) {
                            showAlert('success', 'Sincronizzato con GitHub! 🐙', 
                                'Le modifiche sono state sincronizzate con GitHub');
                        }
                    });
                }
                
                // Aggiornamento UI
                renderTasks();
                updateStats();
                resetForm();
                
            } catch (error) {
                console.error('❌ Errore gestione task:', error);
                showAlert('danger', 'Errore', 'Impossibile salvare il compito: ' + error.message);
                updateStatus('❌ Errore operazione');
            }
        }

        function resetForm() {
            try {
                document.getElementById('taskForm').reset();
                document.getElementById('selectedTags').value = '';
                
                var tagOptions = document.querySelectorAll('.tag-option.selected');
                for (var i = 0; i < tagOptions.length; i++) {
                    tagOptions[i].classList.remove('selected');
                }
                
                // Reset della modalità modifica
                editingTaskId = null;
                
                // Reset del pulsante e indicatori visivi
                var submitButton = document.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.innerHTML = '➕ Aggiungi Compito';
                    submitButton.style.background = 'rgba(255, 255, 255, 0.9)';
                }
                
                var taskForm = document.querySelector('.task-form');
                if (taskForm) {
                    taskForm.style.borderLeft = '';
                }
                
                console.log('🔄 Form resettato, modalità creazione attiva');
                
            } catch (e) {
                console.warn('Errore reset form:', e);
            }
        }

        function deleteTask(taskId) {
            if (!confirm('Sei sicuro di voler eliminare questo compito?')) return;
            
            try {
                var taskIndex = -1;
                var task = null;
                
                for (var i = 0; i < taskManager.tasks.length; i++) {
                    if (taskManager.tasks[i].id === taskId) {
                        taskIndex = i;
                        task = taskManager.tasks[i];
                        break;
                    }
                }
                
                if (taskIndex !== -1 && task) {
                    taskManager.tasks.splice(taskIndex, 1);
                    saveData();
                    renderTasks();
                    updateStats();
                    
                    addNotification('info', 'Compito Eliminato', 
                        'Eliminato: "' + task.title + '"', taskId);
                    
                    showAlert('info', 'Compito Eliminato', 'Il compito è stato rimosso con successo');
                }
            } catch (error) {
                console.error('Errore eliminazione task:', error);
                showAlert('danger', 'Errore', 'Impossibile eliminare il compito');
            }
        }

        function editTask(taskId) {
            try {
                var task = null;
                for (var i = 0; i < taskManager.tasks.length; i++) {
                    if (taskManager.tasks[i].id === taskId) {
                        task = taskManager.tasks[i];
                        break;
                    }
                }
                
                if (!task) {
                    showAlert('warning', 'Errore', 'Compito non trovato');
                    return;
                }
                
                // Imposta modalità modifica
                editingTaskId = taskId;
                console.log('✏️ Attivata modalità modifica per task:', taskId);
                
                // Popola form con i dati del task
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskDescription').value = task.description || '';
                document.getElementById('taskPriority').value = task.priority;
                document.getElementById('taskDueDate').value = task.dueDate || '';
                document.getElementById('taskStatus').value = task.status;
                document.getElementById('enableReminder').checked = task.enableReminder || false;
                
                // Seleziona assegnatari
                var assigneeSelect = document.getElementById('taskAssignee');
                for (var i = 0; i < assigneeSelect.options.length; i++) {
                    var assignees = Array.isArray(task.assignee) ? task.assignee : [task.assignee];
                    assigneeSelect.options[i].selected = assignees.indexOf(assigneeSelect.options[i].value) !== -1;
                }
                
                // Seleziona tags
                var taskTags = task.tags || [];
                var tagOptions = document.querySelectorAll('.tag-option');
                for (var i = 0; i < tagOptions.length; i++) {
                    var tagName = tagOptions[i].getAttribute('data-tag');
                    if (taskTags.indexOf(tagName) !== -1) {
                        tagOptions[i].classList.add('selected');
                    } else {
                        tagOptions[i].classList.remove('selected');
                    }
                }
                updateSelectedTags();
                
                // Aggiorna UI per indicare modalità modifica
                var submitButton = document.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.innerHTML = '✏️ Aggiorna Compito';
                    submitButton.style.background = 'rgba(52, 152, 219, 0.9)';
                }
                
                var taskForm = document.querySelector('.task-form');
                if (taskForm) {
                    taskForm.style.borderLeft = '5px solid #3498db';
                }
                
                // Scroll al form
                taskForm.scrollIntoView({ behavior: 'smooth' });
                
                showAlert('info', 'Modalità Modifica Attiva', 
                    'Stai modificando: "' + task.title + '". Aggiorna i dati e clicca "Aggiorna Compito"');
                
                updateStatus('✏️ Modifica: ' + task.title);
                
            } catch (error) {
                console.error('Errore modifica task:', error);
                showAlert('danger', 'Errore', 'Impossibile modificare il compito');
                editingTaskId = null; // Reset in caso di errore
            }
        }

        function updateTaskStatus(taskId, newStatus) {
            try {
                var task = null;
                for (var i = 0; i < taskManager.tasks.length; i++) {
                    if (taskManager.tasks[i].id === taskId) {
                        task = taskManager.tasks[i];
                        break;
                    }
                }
                
                if (task) {
                    var oldStatus = task.status;
                    task.status = newStatus;
                    task.updatedAt = new Date().toISOString();
                    
                    saveData();
                    renderTasks();
                    updateStats();
                    
                    if (newStatus === 'completato' && oldStatus !== 'completato') {
                        addNotification('completed', 'Compito Completato!', 
                            'Completato: "' + task.title + '"', task.id);
                    }
                }
            } catch (error) {
                console.error('Errore aggiornamento status:', error);
            }
        }

        // Filter System
        function applyFilters() {
            taskManager.filters.assignee = document.getElementById('filterAssignee').value;
            taskManager.filters.priority = document.getElementById('filterPriority').value;
            taskManager.filters.status = document.getElementById('filterStatus').value;
            renderTasks();
        }

        function clearFilters() {
            taskManager.filters = {
                assignee: 'tutti',
                priority: 'tutte',
                status: 'tutti',
                tags: []
            };
            
            document.getElementById('filterAssignee').value = 'tutti';
            document.getElementById('filterPriority').value = 'tutte';
            document.getElementById('filterStatus').value = 'tutti';
            
            renderTasks();
        }

        function getFilteredTasks() {
            return taskManager.tasks.filter(function(task) {
                // Filtro Assegnato
                if (taskManager.filters.assignee !== 'tutti') {
                    var assignees = Array.isArray(task.assignee) ? task.assignee : [task.assignee];
                    if (assignees.indexOf(taskManager.filters.assignee) === -1) {
                        return false;
                    }
                }
                
                // Filtro Priorità
                if (taskManager.filters.priority !== 'tutte' && task.priority !== taskManager.filters.priority) {
                    return false;
                }
                
                // Filtro Stato
                if (taskManager.filters.status !== 'tutti' && task.status !== taskManager.filters.status) {
                    return false;
                }
                
                return true;
            });
        }

        // Rendering
        function renderTasks() {
            var tasksGrid = document.getElementById('tasksGrid');
            if (!tasksGrid) return;
            
            var filteredTasks = getFilteredTasks();
            
            if (filteredTasks.length === 0) {
                tasksGrid.innerHTML = 
                    '<div class="empty-state">' +
                    '<div style="font-size: 4rem; margin-bottom: 20px;">📋</div>' +
                    '<h3>Nessun compito presente</h3>' +
                    '<p>Aggiungi il tuo primo compito utilizzando il form sopra</p>' +
                    '</div>';
                return;
            }
            
            var html = '';
            for (var i = 0; i < filteredTasks.length; i++) {
                var task = filteredTasks[i];
                var assignees = Array.isArray(task.assignee) ? task.assignee : [task.assignee];
                var tags = task.tags || [];
                
                html += 
                    '<div class="task-card">' +
                    '<div class="task-title">' + task.title + getDueBadge(task.dueDate) + '</div>' +
                    '<div class="task-description">' + (task.description || 'Nessuna descrizione') + '</div>' +
                    '<div class="task-meta">' +
                    '<span class="task-assignee">👤 ' + assignees.join(', ') + '</span>' +
                    '<span class="task-date">📅 ' + (task.dueDate ? formatDate(task.dueDate) : 'Nessuna scadenza') + '</span>' +
                    '</div>';
                
                // Tags
                if (tags.length > 0) {
                    html += '<div style="margin-bottom: 15px;">';
                    for (var j = 0; j < tags.length; j++) {
                        var tagColors = {
                            'Urgente': '#e74c3c', 'Cliente': '#3498db', 'Interno': '#95a5a6',
                            'Marketing': '#e67e22', 'Sviluppo': '#27ae60', 'Vendite': '#9b59b6'
                        };
                        html += '<span style="background: ' + (tagColors[tags[j]] || '#95a5a6') + '; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.7rem; margin-right: 4px;">' + tags[j] + '</span>';
                    }
                    html += '</div>';
                }
                
                html += 
                    '<div class="task-status">' +
                    '<span class="task-priority ' + taskManager.priorities[task.priority].class + '">' + taskManager.priorities[task.priority].label + '</span>' +
                    '<select class="status-select" onchange="updateTaskStatus(\'' + task.id + '\', this.value)">';
                
                for (var status in taskManager.taskStates) {
                    var selected = task.status === status ? ' selected' : '';
                    html += '<option value="' + status + '"' + selected + '>' + taskManager.taskStates[status].label + '</option>';
                }
                
                html += '</select></div>' +
                    '<div class="task-actions">' +
                    '<button class="btn-small btn-edit" onclick="editTask(\'' + task.id + '\')">✏️ Modifica</button>' +
                    '<button class="btn-small btn-delete" onclick="deleteTask(\'' + task.id + '\')">🗑️ Elimina</button>' +
                    '</div>' +
                    '</div>';
            }
            
            tasksGrid.innerHTML = html;
        }

        function updateStats() {
            var filteredTasks = getFilteredTasks();
            
            var elements = {
                total: document.getElementById('totalTasks'),
                inProgress: document.getElementById('inProgressTasks'),
                completed: document.getElementById('completedTasks'),
                pending: document.getElementById('pendingTasks')
            };
            
            if (elements.total) elements.total.textContent = filteredTasks.length;
            if (elements.inProgress) elements.inProgress.textContent = filteredTasks.filter(function(t) { return t.status === 'in-corso'; }).length;
            if (elements.completed) elements.completed.textContent = filteredTasks.filter(function(t) { return t.status === 'completato'; }).length;
            if (elements.pending) elements.pending.textContent = filteredTasks.filter(function(t) { return t.status === 'da-iniziare'; }).length;
        }

        // Sistema di Condivisione tramite URL - VERSIONE MIGLIORATA
        function shareData() {
            try {
                if (taskManager.tasks.length === 0) {
                    showAlert('warning', 'Nessun Compito', 'Non ci sono compiti da condividere. Crea almeno un compito prima di condividere.');
                    return;
                }

                var data = {
                    tasks: taskManager.tasks,
                    notifications: taskManager.notifications.slice(0, 5), // Solo le ultime 5
                    timestamp: new Date().toISOString(),
                    version: '2.0'
                };
                
                console.log('📤 Preparazione condivisione:', data.tasks.length, 'compiti');
                
                var jsonData = JSON.stringify(data);
                var compressedData = btoa(unescape(encodeURIComponent(jsonData))); // Fix encoding
                
                // Controlla lunghezza URL (limite browser ~2000 caratteri)
                if (compressedData.length > 1500) {
                    showAlert('warning', 'Troppi Dati', 
                        'I compiti sono troppi per essere condivisi via URL. Prova con meno compiti o usa l\'export CSV.');
                    return;
                }
                
                var shareUrl = window.location.origin + window.location.pathname + '?share=' + encodeURIComponent(compressedData);
                
                console.log('🔗 URL generato, lunghezza:', shareUrl.length);
                
                // Test immediato del link
                testShareUrl(compressedData, function(success) {
                    if (success) {
                        showShareModal(shareUrl, data);
                    } else {
                        showAlert('danger', 'Errore Condivisione', 'Impossibile generare un link valido. Prova con meno compiti.');
                    }
                });
                
            } catch (error) {
                console.error('❌ Errore condivisione:', error);
                showAlert('danger', 'Errore Condivisione', 'Errore tecnico: ' + error.message);
            }
        }

        function testShareUrl(compressedData, callback) {
            try {
                // Test decodifica
                var jsonData = decodeURIComponent(escape(atob(compressedData)));
                var testData = JSON.parse(jsonData);
                
                console.log('✅ Test link OK:', testData.tasks.length, 'compiti');
                callback(true);
            } catch (error) {
                console.error('❌ Test link fallito:', error);
                callback(false);
            }
        }

        function showShareModal(shareUrl, data) {
            var modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 2000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            var modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; border-radius: 15px; padding: 30px; 
                max-width: 700px; width: 95%; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                max-height: 85vh; overflow-y: auto;
            `;
            
            var shortUrl = shareUrl.length > 100 ? shareUrl.substring(0, 100) + '...' : shareUrl;
            
            modalContent.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #2c3e50;">📤 Condividi Compiti con i Colleghi</h3>
                
                <div style="background: #e8f5e8; border: 2px solid #27ae60; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>📊 Dati da condividere:</strong><br>
                    ✅ ${data.tasks.length} compiti<br>
                    📱 ${data.notifications.length} notifiche recenti<br>
                    🕐 Aggiornato: ${new Date(data.timestamp).toLocaleString('it-IT')}<br>
                    📏 Dimensione link: ${shareUrl.length} caratteri
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">🔗 Link di Condivisione:</label>
                    <div style="display: flex; gap: 10px;">
                        <textarea id="shareUrlText" readonly style="flex: 1; height: 60px; padding: 10px; border: 2px solid #3498db; border-radius: 5px; font-size: 11px; font-family: monospace;">${shareUrl}</textarea>
                        <button onclick="copyShareUrl()" style="background: #3498db; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; white-space: nowrap;">
                            📋 Copia
                        </button>
                    </div>
                    <small style="color: #7f8c8d;">Link abbreviato: ${shortUrl}</small>
                </div>
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>⚠️ IMPORTANTE - Come funziona:</strong><br>
                    1️⃣ Copia il link completo (tutto il testo sopra)<br>
                    2️⃣ Invia ai colleghi (WhatsApp, Email, Telegram)<br>
                    3️⃣ I colleghi devono cliccare il link COMPLETO<br>
                    4️⃣ L'app si aprirà con i compiti già caricati<br>
                    5️⃣ I compiti si salveranno sui loro browser
                </div>
                
                <div style="margin-bottom: 20px;">
                    <strong>🔍 DEBUG INFO:</strong><br>
                    • URL attuale: ${window.location.href}<br>
                    • Protocollo: ${window.location.protocol}<br>
                    • Browser: ${navigator.userAgent.substring(0, 50)}...
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="copyShareUrl()" style="background: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        📋 Copia Link
                    </button>
                    <button onclick="testSharedLink()" style="background: #27ae60; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        🔍 Test Link
                    </button>
                    <button onclick="sendWhatsAppShare('${encodeURIComponent(shareUrl)}')" style="background: #25D366; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        💬 WhatsApp
                    </button>
                    <button onclick="sendEmailShare('${encodeURIComponent(shareUrl)}')" style="background: #EA4335; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        📧 Email
                    </button>
                    <button onclick="closeShareModal()" style="background: #95a5a6; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer;">
                        ❌ Chiudi
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            modal.id = 'shareModal';
        }

        function copyShareUrl() {
            var textarea = document.getElementById('shareUrlText');
            if (textarea) {
                textarea.select();
                textarea.setSelectionRange(0, 99999); // Mobile
                
                try {
                    var successful = document.execCommand('copy');
                    if (successful) {
                        showAlert('success', 'Link Copiato ✅', 'Il link completo è stato copiato negli appunti. Incollalo e invialo ai colleghi.');
                    } else {
                        showAlert('warning', 'Copia Manuale', 'Seleziona tutto il testo e copialo manualmente (Ctrl+C)');
                    }
                } catch (err) {
                    showAlert('warning', 'Copia Manuale', 'Seleziona tutto il testo e copialo manualmente (Ctrl+C)');
                }
            }
        }

        function testSharedLink() {
            var textarea = document.getElementById('shareUrlText');
            var url = textarea.value;
            
            showAlert('info', 'Test Link', 'Apertura del link in una nuova finestra per verificare che funzioni...');
            
            // Apri in nuova finestra
            var testWindow = window.open(url, '_blank');
            
            if (testWindow) {
                setTimeout(function() {
                    showAlert('success', 'Test Completato', 
                        'Se nella nuova finestra vedi i compiti, il link funziona! ' +
                        'Altrimenti controlla la console per errori.');
                }, 2000);
            } else {
                showAlert('warning', 'Popup Bloccato', 
                    'Il popup è stato bloccato. Copia il link manualmente e aprilo in una nuova scheda.');
            }
        }

        function sendWhatsAppShare(shareUrl) {
            var decodedUrl = decodeURIComponent(shareUrl);
            var message = '📋 *Compiti Gruppo Visconti - AGGIORNAMENTO*\n\n' +
                         '🔗 *CLICCA QUESTO LINK COMPLETO:*\n' + decodedUrl + '\n\n' +
                         '📝 *ISTRUZIONI IMPORTANTI:*\n' +
                         '1️⃣ Clicca il link sopra (tutto quanto)\n' +
                         '2️⃣ L\'app si aprirà con i compiti\n' +
                         '3️⃣ I dati si salveranno automaticamente\n' +
                         '4️⃣ Se non funziona, riprova o fammi sapere\n\n' +
                         '⚠️ *IMPORTANTE:* Usa il link completo!\n\n' +
                         '📱 Gruppo Visconti - Task Manager';
            
            window.open('https://wa.me/?text=' + encodeURIComponent(message), '_blank');
        }

        function sendEmailShare(shareUrl) {
            var decodedUrl = decodeURIComponent(shareUrl);
            var subject = '📋 Compiti Gruppo Visconti - Link Condiviso';
            var body = 'Ciao!\n\n' +
                      'Ti invio l\'aggiornamento dei compiti del team Gruppo Visconti.\n\n' +
                      '🔗 LINK DIRETTO (COPIA TUTTO):\n' + decodedUrl + '\n\n' +
                      '📝 COME USARLO:\n' +
                      '1. Copia TUTTO il link sopra\n' +
                      '2. Incollalo nel browser e premi INVIO\n' +
                      '3. L\'app si aprirà con tutti i compiti aggiornati\n' +
                      '4. I dati si salveranno sul tuo browser\n\n' +
                      '⚠️ IMPORTANTE:\n' +
                      '- Usa il link COMPLETO (non tagliare nulla)\n' +
                      '- Se non funziona, fammi sapere subito\n' +
                      '- I compiti sono aggiornati al ' + new Date().toLocaleDateString('it-IT') + '\n\n' +
                      'Grazie!\n\n' +
                      '---\n' +
                      'Gruppo Visconti - Task Manager\n' +
                      'Join the ReEvolution';
            
            window.open('mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body), '_blank');
        }

        function closeShareModal() {
            var modal = document.getElementById('shareModal');
            if (modal) {
                modal.remove();
            }
        }

        // Caricamento dati da URL - VERSIONE MIGLIORATA
        function loadDataFromUrl() {
            try {
                var urlParams = new URLSearchParams(window.location.search);
                var sharedData = urlParams.get('share'); // Cambiato da 'data' a 'share'
                
                console.log('🔍 Controllo dati condivisi nell\'URL...');
                
                if (sharedData) {
                    console.log('📥 Trovati dati condivisi, lunghezza:', sharedData.length);
                    
                    // Decodifica migliorata
                    var jsonData = decodeURIComponent(escape(atob(sharedData)));
                    var decodedData = JSON.parse(jsonData);
                    
                    console.log('✅ Decodifica OK:', decodedData);
                    
                    if (decodedData.tasks && Array.isArray(decodedData.tasks) && decodedData.tasks.length > 0) {
                        var existingTasks = taskManager.tasks.length;
                        var newTasks = decodedData.tasks.length;
                        
                        console.log('📊 Compiti esistenti:', existingTasks, 'Nuovi compiti:', newTasks);
                        
                        var shouldReplace = true; // Default: sostituisci
                        
                        if (existingTasks > 0) {
                            var message = '🔄 DATI CONDIVISI RICEVUTI\n\n' +
                                         '📥 Nuovi compiti: ' + newTasks + '\n' +
                                         '💾 Compiti attuali: ' + existingTasks + '\n\n' +
                                         'Come vuoi procedere?\n\n' +
                                         '✅ OK = SOSTITUISCI tutto con i nuovi dati\n' +
                                         '❌ ANNULLA = AGGIUNGI ai dati esistenti';
                            
                            shouldReplace = confirm(message);
                        }
                        
                        if (shouldReplace) {
                            // Sostituisci tutto
                            taskManager.tasks = decodedData.tasks;
                            taskManager.notifications = decodedData.notifications || [];
                            console.log('🔄 Dati sostituiti');
                        } else {
                            // Aggiungi ai dati esistenti
                            taskManager.tasks = taskManager.tasks.concat(decodedData.tasks);
                            if (decodedData.notifications) {
                                taskManager.notifications = taskManager.notifications.concat(decodedData.notifications);
                            }
                            console.log('➕ Dati aggiunti');
                        }
                        
                        // Salva e aggiorna UI
                        saveData();
                        renderTasks();
                        renderNotifications();
                        updateStats();
                        
                        // Rimuovi parametri dall'URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        showAlert('success', 'Compiti Ricevuti! 🎉', 
                            'Caricati con successo ' + newTasks + ' compiti condivisi. ' +
                            'Dati aggiornati al: ' + new Date(decodedData.timestamp).toLocaleString('it-IT'));
                        
                        addNotification('info', 'Dati Condivisi Ricevuti', 
                            'Caricati ' + newTasks + ' compiti dal team');
                        
                        updateStatus('📥 Compiti condivisi caricati');
                        
                        return true;
                    } else {
                        console.warn('⚠️ Dati condivisi non validi o vuoti');
                        showAlert('warning', 'Dati Non Validi', 'I dati condivisi sembrano essere vuoti o corrotti.');
                    }
                } else {
                    console.log('ℹ️ Nessun dato condiviso nell\'URL');
                }
                
                return false;
                
            } catch (error) {
                console.error('❌ Errore caricamento dati condivisi:', error);
                showAlert('danger', 'Errore Condivisione', 
                    'Impossibile caricare i dati condivisi. Link danneggiato o non valido.\n\nErrore: ' + error.message);
                return false;
            }
        }
        function exportData() {
            try {
                var filteredTasks = getFilteredTasks();
                if (filteredTasks.length === 0) {
                    showAlert('warning', 'Nessun Dato', 'Non ci sono compiti da esportare');
                    return;
                }
                
                var csvContent = 'Titolo,Descrizione,Assegnato a,Priorità,Stato,Scadenza,Tags,Creato il\n';
                
                for (var i = 0; i < filteredTasks.length; i++) {
                    var task = filteredTasks[i];
                    var assignees = Array.isArray(task.assignee) ? task.assignee.join('; ') : task.assignee;
                    var tags = task.tags ? task.tags.join('; ') : '';
                    
                    var row = [
                        '"' + (task.title || '').replace(/"/g, '""') + '"',
                        '"' + (task.description || '').replace(/"/g, '""') + '"',
                        '"' + assignees + '"',
                        '"' + taskManager.priorities[task.priority].label + '"',
                        '"' + taskManager.taskStates[task.status].label + '"',
                        '"' + (task.dueDate ? formatDate(task.dueDate) : '') + '"',
                        '"' + tags + '"',
                        '"' + formatDate(task.createdAt) + '"'
                    ].join(',');
                    
                    csvContent += row + '\n';
                }
                
                var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                var link = document.createElement('a');
                
                if (link.download !== undefined) {
                    var fileName = 'Compiti_GruppoVisconti_' + new Date().toISOString().split('T')[0] + '.csv';
                    var url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', fileName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showAlert('success', 'Export Completato', 'File CSV scaricato con successo');
                } else {
                    showAlert('danger', 'Errore Export', 'Download non supportato su questo browser');
                }
            } catch (error) {
                console.error('Errore export:', error);
                showAlert('danger', 'Errore Export', 'Impossibile esportare i dati');
            }
        }

        function clearAllData() {
            if (!confirm('Sei sicuro di voler eliminare TUTTI i compiti e le notifiche? Questa azione non può essere annullata.')) {
                return;
            }
            
            try {
                taskManager.tasks = [];
                taskManager.notifications = [];
                
                // Pulizia storage
                if (typeof Storage !== "undefined") {
                    if (window.localStorage) {
                        localStorage.removeItem('gruppoViscontiTasks_v2');
                    }
                    if (window.sessionStorage) {
                        sessionStorage.removeItem('gruppoViscontiTasks_v2');
                    }
                }
                
                if (window.tempTaskData) {
                    delete window.tempTaskData;
                }
                
                renderTasks();
                renderNotifications();
                updateStats();
                
                showAlert('info', 'Dati Cancellati', 'Tutti i compiti e le notifiche sono stati eliminati');
                updateStatus('🗑️ Dati cancellati');
                
            } catch (error) {
                console.error('Errore pulizia dati:', error);
                showAlert('danger', 'Errore', 'Impossibile cancellare tutti i dati');
            }
        }

        function addDemoData() {
            try {
                var sampleTasks = [
                    {
                        id: generateId(),
                        title: 'Preparare presentazione Q4 2024',
                        description: 'Creare slides per la presentazione dei risultati del quarto trimestre con analisi dettagliata delle performance aziendali e proiezioni per il 2025',
                        assignee: ['LUCIANO', 'ANTONIO'],
                        priority: 'alta',
                        dueDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'in-corso',
                        tags: ['Urgente', 'Cliente'],
                        enableReminder: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        createdBy: 'Admin'
                    },
                    {
                        id: generateId(),
                        title: 'Aggiornamento sito web aziendale',
                        description: 'Implementare le nuove funzionalità richieste dal cliente e ottimizzare la user experience per migliorare il tasso di conversione',
                        assignee: ['LUIGI', 'DARIO'],
                        priority: 'media',
                        dueDate: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'da-iniziare',
                        tags: ['Sviluppo', 'Cliente'],
                        enableReminder: false,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        createdBy: 'Admin'
                    },
                    {
                        id: generateId(),
                        title: 'Campagna marketing sui social media',
                        description: 'Pianificare e lanciare la nuova campagna promozionale per il lancio del prodotto con focus su Instagram e LinkedIn',
                        assignee: ['NOEMI'],
                        priority: 'media',
                        dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'completato',
                        tags: ['Marketing', 'Interno'],
                        enableReminder: false,
                        createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                        updatedAt: new Date().toISOString(),
                        createdBy: 'Admin'
                    },
                    {
                        id: generateId(),
                        title: 'Analisi finanziaria mensile',
                        description: 'Preparare il report finanziario mensile con KPI e budget analysis per il board di direzione',
                        assignee: ['VINCENZO'],
                        priority: 'alta',
                        dueDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'in-revisione',
                        tags: ['Interno', 'Urgente'],
                        enableReminder: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        createdBy: 'Admin'
                    },
                    {
                        id: generateId(),
                        title: 'Gestione progetto cliente Premium',
                        description: 'Coordinare tutte le attività per il cliente Premium e seguire l\'implementazione della nuova soluzione enterprise',
                        assignee: ['ROBERTO', 'MARIANO'],
                        priority: 'alta',
                        dueDate: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'in-corso',
                        tags: ['Cliente', 'Vendite'],
                        enableReminder: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        createdBy: 'Admin'
                    }
                ];
                
                // Aggiungi i task demo a quelli esistenti
                taskManager.tasks = taskManager.tasks.concat(sampleTasks);
                
                // Aggiungi alcune notifiche demo
                for (var i = 0; i < sampleTasks.length; i++) {
                    var task = sampleTasks[i];
                    addNotification('assigned', 'Task Demo Creato', 
                        'Aggiunto task demo: "' + task.title + '"', task.id);
                }
                
                saveData();
                renderTasks();
                updateStats();
                
                showAlert('success', 'Dati Demo Aggiunti', 
                    'Sono stati aggiunti ' + sampleTasks.length + ' compiti di esempio per il team');
                
            } catch (error) {
                console.error('Errore aggiunta dati demo:', error);
                showAlert('danger', 'Errore', 'Impossibile aggiungere i dati demo');
            }
        }

        // Auto-save System
        function startAutoSave() {
            setInterval(function() {
                if (taskManager.tasks.length > 0 || taskManager.notifications.length > 0) {
                    saveData();
                }
            }, 30000); // Ogni 30 secondi
        }

        // Initialization
        function init() {
            console.log('🚀 Inizializzazione Task Manager Gruppo Visconti v2.0');
            updateStatus('🔄 Inizializzazione...');
            
            try {
                // Test del sistema storage
                testStorage();
                
                // Carica configurazione GitHub
                try {
                    loadGitHubConfig();
                } catch (e) {
                    console.warn('GitHub config non disponibile:', e.message);
                }
                
                // Caricamento dati (prima da URL condiviso, poi locali)
                var sharedDataLoaded = loadDataFromUrl();
                var dataLoaded = sharedDataLoaded || loadData();
                
                // Setup eventi form
                var taskForm = document.getElementById('taskForm');
                if (taskForm) {
                    taskForm.addEventListener('submit', addTask);
                } else {
                    console.error('Form non trovato');
                }
                
                // Inizializzazione componenti
                initializeTags();
                
                // Render iniziale
                renderTasks();
                renderNotifications();
                updateStats();
                
                // Avvio auto-save
                startAutoSave();
                
                // Messaggio di benvenuto
                if (!dataLoaded || taskManager.tasks.length === 0) {
                    setTimeout(function() {
                        showAlert('info', 'Benvenuto nel Task Manager!', 
                            'Questa è la prima volta che usi l\'app. Clicca "Dati Demo" per vedere alcuni esempi o crea il tuo primo compito!', 8000);
                    }, 1000);
                } else {
                    setTimeout(function() {
                        showAlert('success', 'Sistema Pronto', 
                            'Task Manager caricato con ' + taskManager.tasks.length + ' compiti e ' + taskManager.notifications.length + ' notifiche');
                    }, 500);
                }
                
                updateStatus('✅ Sistema pronto');
                console.log('✅ Task Manager inizializzato con successo');
                
                // Test funzioni globali
                console.log('🔧 Test funzioni Google Sheets:', typeof window.openGoogleSheetsGuide);
                
            } catch (error) {
                console.error('❌ Errore inizializzazione:', error);
                updateStatus('❌ Errore inizializzazione');
                showAlert('danger', 'Errore Sistema', 'Errore durante l\'inizializzazione: ' + error.message);
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            init();
        });

        // Salvataggio prima della chiusura
        window.addEventListener('beforeunload', function() {
            saveData();
        });

        // Salvataggio quando la pagina perde il focus
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                saveData();
            }
        });

        // Definisci subito le funzioni globali all'inizio
        window.openGoogleSheetsGuide = openGoogleSheetsGuide;
        window.setupGitHubIntegration = setupGitHubIntegration;
        window.testGitHubConnection = testGitHubConnection;
        window.activateGitHubSync = activateGitHubSync;
        window.syncExistingTasks = syncExistingTasks;
        window.closeGitHubModal = closeGitHubModal;
        
        // Funzioni globali per debugging e condivisione
        window.taskManager = taskManager;
        window.testStorage = testStorage;
        window.saveData = saveData;
        window.loadData = loadData;
        window.addDemoData = addDemoData;
        window.clearAllData = clearAllData;
        window.exportData = exportData;
        window.shareData = shareData;
        window.copyShareUrl = copyShareUrl;
        window.sendWhatsAppShare = sendWhatsAppShare;
        window.sendEmailShare = sendEmailShare;
        window.setupGoogleSheets = setupGoogleSheets;
        window.testGoogleSheets = testGoogleSheets;
        window.saveGoogleSheetsConfig = saveGoogleSheetsConfig;
        window.exportToGoogleSheets = exportToGoogleSheets;
        window.copyGoogleSheetsData = copyGoogleSheetsData;
        window.openGoogleSheets = openGoogleSheets;
        window.closeGoogleSheetsModal = closeGoogleSheetsModal;
        window.closeGoogleSheetsInstructions = closeGoogleSheetsInstructions;
        window.testSharedLink = testSharedLink;
        window.addTask = addTask;
        window.deleteTask = deleteTask;
        window.editTask = editTask;
        window.updateTaskStatus = updateTaskStatus;
        window.applyFilters = applyFilters;
        window.clearFilters = clearFilters;
        window.closeAlert = closeAlert;

        console.log('📱 Task Manager GitHub Pages v2.0 - Ready!');
        
    </script>
</body>
</html>
